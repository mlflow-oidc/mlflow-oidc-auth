[tox]
envlist = py314
skipsdist = True

[testenv]
deps =
    pytest
    coverage<=7.6
    httpx
commands =
    pip install -e '.[full,test]'
    coverage run -m pytest -s -m "not integration" mlflow_oidc_auth/tests
    coverage xml

[testenv:integration]
description = Run browser-based integration tests against a running mlflow-oidc-auth instance.
deps =
    {[testenv]deps}
    playwright
    httpx
    mlflow>=3.3.1,<4
    httpx
passenv =
    MLFLOW_OIDC_E2E_BASE_URL
    MLFLOW_OIDC_E2E_REQUIRE
    OIDC_*
    AUTH0_*
    OKTA_*
    KEYCLOAK_*
    MLFLOW_*
commands_pre =
    python -m playwright install chromium
commands =
    pip install -e '.[full,test]'
    pytest -m integration mlflow_oidc_auth/tests/integration {posargs}

[testenv:integration-live]
description = Run integration tests against an already running mlflow-oidc-auth instance (no install/setup).
skip_install = True
deps =
    {[testenv]deps}
    playwright
    mlflow>=3.8.1,<4
passenv = {[testenv:integration]passenv}
commands_pre =
    python -m pip install "mlflow<4,>=3.8.1"
commands =
    pytest -m integration mlflow_oidc_auth/tests/integration {posargs}

[coverage:run]
# relative_files = True
source = mlflow_oidc_auth/
branch = True
